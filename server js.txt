// server.js
const express = require('express');
const app = express();
const PORT = process.env.PORT || 3000;

app.use(express.json());

let ultimoEstado = {
  estado: 'offline',
  ip: null,
  ultima: null,
  senal: null
};

// Recibe datos del ESP32
app.post('/data', (req, res) => {
  const d = req.body;
  const ahora = new Date().toISOString();
  if (d.estado) {
    ultimoEstado.estado = d.estado;
    ultimoEstado.ip = d.ip || ultimoEstado.ip;
  }
  if (d.senal !== undefined) {
    ultimoEstado.senal = d.senal;
  }
  ultimoEstado.ultima = ahora;
  console.log('üì© Datos recibidos:', d);
  res.status(200).json({ ok: true, received: d });
});

// P√°gina para ver el √∫ltimo estado (√∫til para el navegador)
app.get('/', (req, res) => {
  res.send(`
    <h1>Estado ESP32 ‚Äî Cardiacosp</h1>
    <p><strong>Estado:</strong> ${ultimoEstado.estado}</p>
    <p><strong>IP:</strong> ${ultimoEstado.ip}</p>
    <p><strong>√öltima actualizaci√≥n:</strong> ${ultimoEstado.ultima}</p>
    <p><strong>Se√±al:</strong> ${ultimoEstado.senal}</p>
    <hr>
    <p>POST /data con JSON {"senal":X} actualizar√° estos valores.</p>
  `);
});

app.listen(PORT, '0.0.0.0', () => {
  console.log(`Servidor ejecut√°ndose en puerto ${PORT}`);
});
